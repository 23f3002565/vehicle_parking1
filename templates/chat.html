{% extends 'base.html' %}

{% block title %}Community Chat{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-comments"></i> Community Chat</h5>
        </div>
        <div class="card-body">
            <div id="messages" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
                {% for message in messages %}
                <div class="mb-2">
                    <strong {% if message[3] %}class="text-danger"{% endif %}>
                        {{ message[0] }}{% if message[3] %} (Admin){% endif %}:
                    </strong>
                    {{ message[1] }}
                    <small class="text-muted">({{ message[2] }})</small>
                </div>
                {% endfor %}
            </div>
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="Type a message...">
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script>
const socket = io();

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (message) {
        socket.emit('message', {message: message});
        input.value = '';
    }
}

socket.on('message', function(data) {
    const messages = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'mb-2';
    div.innerHTML = `<strong ${data.is_admin ? 'class="text-danger"' : ''}>${data.username}${data.is_admin ? ' (Admin)' : ''}:</strong> ${data.message} <small class="text-muted">(${data.timestamp})</small>`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
});

document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});
</script>
{% endblock %}